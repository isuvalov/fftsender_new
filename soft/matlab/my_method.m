len=2048;  % ????????????? ?????? FFT
AREA_SIZE=11;
SEE_THE_FUTURE=0;%AREA_SIZE-1;
fd=100;

t=0:1/fd:len/fd-1/fd;
len2=floor(len/2);

test_signal=sin(2*pi*t*10);%+sin(2*pi*t*10.16);  % ?????? ???????? ?????? ? ????? ??????????

find_all=0;
prev_maximum_exist_cnt=AREA_SIZE  ;

for iterations=1:100
    max_array=[];
    prev_maximum_val=0;
    can_calc=1;
    
    test_signal_n=awgn(test_signal,10);
    test_signal_f=abs(fft(test_signal_n));
    test_signal_f=test_signal_f(1:floor(len/2));
    for z=1:len2-AREA_SIZE-SEE_THE_FUTURE-1
        area=test_signal_f(1+z:AREA_SIZE+z+SEE_THE_FUTURE);
        if 	prev_maximum_exist_cnt<floor(AREA_SIZE/2); % ?????? ????? guadr ???????? - ????????? ?? 16% ?? ???-?? ??????????????? ????????
            prev_maximum_exist_cnt=prev_maximum_exist_cnt+1;
            if (prev_maximum_val<area(5))
                can_calc=1;
            else
                can_calc=0;
            end
        else
            prev_maximum_exist_cnt=0;		
            can_calc=1;
        end

        mul_thr=floor(0.3*area(5));
        mul_thr_future=floor(0.3*area(5+SEE_THE_FUTURE));
        if (  ~((area(5-1)>mul_thr) || (area(5+1)>mul_thr)      ||  (area(5-2)>mul_thr) || (area(5+2)>mul_thr)) )
            test_extremum1=1;
        else
            test_extremum1=0;
        end

        if (~((area(5-1+SEE_THE_FUTURE)>mul_thr_future) || (area(5+1+SEE_THE_FUTURE)>mul_thr_future)      ||  (area(5-2+SEE_THE_FUTURE)>mul_thr_future) || (area(5+2+SEE_THE_FUTURE)>mul_thr_future)) )
            test_extremum2=1;
        else
            test_extremum2=0;
        end        
%         if ( area(5)==max(area(1:AREA_SIZE)) && (test_extremum1==1) && (can_calc==1) )  % ????????? ??????? ????? ???????? ?????????? ?????????? ??? ??? - ??????? 50%!
%              if ((test_extremum1==1) && (can_calc==1) && test_extremum2==0)            % ????????? ??????? ?? ?????? ????????, ?????????? ?? ????????? ? ?????????? ??????????       
             if ((test_extremum1==1) && (can_calc==1))                                  % ????? ???????? ??? ?? ??? ? ????????? ?? ??
                max_array=[max_array (z+5)];
                prev_maximum_val=area(5);
                prev_maximum_exist_cnt=0;
        end 
    end %z
    find_all=find_all+length(max_array);
    pic=stem([1 max_array len2],[0 test_signal_f(max_array) 0]);
    drawnow; pause(0.1)
end % iterations
fprintf('Finish. Find %i freqs\n',find_all);
